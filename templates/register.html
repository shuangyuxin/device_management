{% extends "base.html" %}

{% block title %}用户注册 - 设备管理系统{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-person-plus"></i> 用户注册
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('register') }}" id="registerForm">
                    <div class="row g-3">
                        <!-- 用户名 -->
                        <div class="col-md-6">
                            <label for="username" class="form-label">用户名 *</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                            <div class="form-text">3-20个字符，只能包含字母、数字和下划线</div>
                        </div>
                        
                        <!-- 邮箱 -->
                        <div class="col-md-6">
                            <label for="email" class="form-label">邮箱 *</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                            <div class="form-text">用于接收系统通知</div>
                        </div>
                        
                        <!-- 邀请码 -->
                        <div class="col-12">
                            <label for="invitation_code" class="form-label">邀请码 *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="invitation_code" name="invitation_code" required placeholder="请输入邀请码">
                                <button type="button" class="btn btn-outline-secondary" onclick="copyInvitationCode()">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                            <div class="form-text">请向管理员获取邀请码</div>
                        </div>
                        
                        <!-- 密码 -->
                        <div class="col-md-6">
                            <label for="password" class="form-label">密码 *</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                            <div class="form-text">至少6个字符</div>
                        </div>
                        
                        <!-- 确认密码 -->
                        <div class="col-md-6">
                            <label for="confirm_password" class="form-label">确认密码 *</label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                        </div>
                        
                        <!-- 真实姓名 -->
                        <div class="col-md-6">
                            <label for="real_name" class="form-label">真实姓名</label>
                            <input type="text" class="form-control" id="real_name" name="real_name">
                        </div>
                        
                        <!-- 部门 -->
                        <div class="col-md-6">
                            <label for="department" class="form-label">部门</label>
                            <input type="text" class="form-control" id="department" name="department">
                        </div>
                        
                        <!-- 用户协议 -->
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agree_terms" required>
                                <label class="form-check-label" for="agree_terms">
                                    我同意 <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">用户协议</a>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-person-plus"></i> 注册
                        </button>
                        <a href="{{ url_for('login') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> 返回登录
                        </a>
                    </div>
                </form>
                
                <hr class="my-4">
                
                <div class="text-center">
                    <p class="text-muted">已有账户？ <a href="{{ url_for('login') }}">直接登录</a></p>
                </div>
            </div>
        </div>
        
        <!-- 注册说明 -->
        <div class="card mt-3">
            <div class="card-body">
                <h6>注册说明：</h6>
                <ul class="small">
                    <li>注册需要有效的邀请码，请向管理员获取</li>
                    <li>注册后即可使用设备管理系统的全部功能</li>
                    <li>普通用户可以查看设备、借用设备、查看借用记录</li>
                    <li>管理员可以管理所有用户和设备</li>
                    <li>请妥善保管您的账户信息</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- 用户协议模态框 -->
<div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">用户协议</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>一、总则</h6>
                <p>欢迎使用设备管理系统。在注册成为本系统用户之前，请仔细阅读本协议。</p>
                
                <h6>二、用户责任</h6>
                <p>1. 用户应妥善保管账户信息，不得转让或出借给他人使用。</p>
                <p>2. 用户应对借用设备的保管和使用负责。</p>
                <p>3. 用户不得利用本系统进行任何违法或不正当的活动。</p>
                
                <h6>三、系统使用</h6>
                <p>1. 本系统用于设备管理和借用记录。</p>
                <p>2. 管理员有权对违规用户进行限制或删除。</p>
                <p>3. 系统有权根据需要对功能进行调整。</p>
                
                <h6>四、免责声明</h6>
                <p>1. 因用户个人原因造成的损失，系统不承担责任。</p>
                <p>2. 系统会尽力保障数据安全，但不保证绝对安全。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 密码强度检查
document.getElementById('password').addEventListener('input', function() {
    const password = this.value;
    const strength = checkPasswordStrength(password);
    const feedback = document.getElementById('passwordFeedback') || document.createElement('div');
    
    feedback.id = 'passwordFeedback';
    feedback.className = 'form-text';
    
    if (password.length === 0) {
        feedback.textContent = '请输入密码';
        feedback.className = 'form-text';
    } else if (strength === 'weak') {
        feedback.textContent = '密码强度：弱';
        feedback.className = 'form-text text-danger';
    } else if (strength === 'medium') {
        feedback.textContent = '密码强度：中等';
        feedback.className = 'form-text text-warning';
    } else {
        feedback.textContent = '密码强度：强';
        feedback.className = 'form-text text-success';
    }
    
    if (!this.nextElementSibling || this.nextElementSibling.id !== 'passwordFeedback') {
        this.parentNode.appendChild(feedback);
    }
});

// 检查密码强度
function checkPasswordStrength(password) {
    let score = 0;
    
    // 长度检查
    if (password.length >= 8) score += 1;
    if (password.length >= 12) score += 1;
    
    // 包含小写字母
    if (/[a-z]/.test(password)) score += 1;
    
    // 包含大写字母
    if (/[A-Z]/.test(password)) score += 1;
    
    // 包含数字
    if (/[0-9]/.test(password)) score += 1;
    
    // 包含特殊字符
    if (/[^a-zA-Z0-9]/.test(password)) score += 1;
    
    if (score <= 2) return 'weak';
    if (score <= 4) return 'medium';
    return 'strong';
}

// 复制邀请码功能
function copyInvitationCode() {
    const code = prompt('请输入邀请码（通常由管理员提供）:', '');
    if (code) {
        document.getElementById('invitation_code').value = code.toUpperCase();
    }
}

// 表单验证
document.getElementById('registerForm').addEventListener('submit', function(e) {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const agreeTerms = document.getElementById('agree_terms').checked;
    
    if (password !== confirmPassword) {
        e.preventDefault();
        alert('两次输入的密码不一致！');
        return false;
    }
    
    if (!agreeTerms) {
        e.preventDefault();
        alert('请同意用户协议！');
        return false;
    }
    
    return true;
});
</script>
{% endblock %}